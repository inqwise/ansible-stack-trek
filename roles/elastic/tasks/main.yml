---
- debug: var=es_discovery.ec2.es_cluster
  tags: debug
- debug: var=environment_name
  tags: debug
- debug: var=discord_message_owner_name
  tags: debug

- name: Install
  tags: installation
  block:
    - name: Add Elasticsearch gpg key
      rpm_key:
        key: https://artifacts.elastic.co/GPG-KEY-elasticsearch
        state: present

    - name: Copy elasticsearch.repo file with owner and permission, using symbolic representation
      ansible.builtin.copy:
        src: elasticsearch.repo
        dest: /etc/yum.repos.d/elasticsearch.repo
        owner: root
        group: root
        mode: u=rw,g=r,o=r

    - name: install elastic and common software requirements
      ansible.builtin.package:
        name:
          - 'htop'
          - 'net-tools'
          - elasticsearch
        state: present

    - name: include aws-plugins
      ansible.builtin.include_tasks:
        name: aws-plugins.yml
        apply:
          tags: installation
      tags: installation
      when: es_discovery['ec2'] is defined

    - import_role:
        name: inqwise.common.os_tune
        tasks_from: elastic

  when: elastic_install|default(True)

- name: Configure
  block:
    - name: check-set-parameters
      ansible.builtin.include_tasks:
        name: elasticsearch-parameters.yml
        apply:
          tags: configuration
      tags: configuration

    - name: include elasticsearch-config.yml
      ansible.builtin.include_tasks:
        name: elasticsearch-config.yml
        apply:
          tags: configuration
      tags: configuration            

  when: elastic_configure|default(True)
---
- debug: var=es_discovery.ec2.es_cluster
  tags: debug
- debug: var=environment_name
  tags: debug
- debug: var=discord_message_owner_name
  tags: debug

- name: Install
  tags: installation
  block:
    - name: Add Elasticsearch GPG key
      rpm_key:
        key: https://artifacts.elastic.co/GPG-KEY-elasticsearch
        state: present

    - name: Copy elasticsearch.repo file with owner and permission, using symbolic representation
      ansible.builtin.copy:
        src: elasticsearch.repo
        dest: /etc/yum.repos.d/elasticsearch.repo
        owner: root
        group: root
        mode: u=rw,g=r,o=r

    - name: Install elastic and common software requirements
      ansible.builtin.package:
        name:
          - 'htop'
          - 'net-tools'
          - elasticsearch
        state: present

    - name: Include aws-plugins
      ansible.builtin.include_tasks: aws-plugins.yml
      tags: installation
      when: es_discovery['ec2'] is defined

    - ansible.builtin.import_role:
        name: inqwise.common.os_tune
        tasks_from: elastic

  when: elastic_install

- name: Configure
  tags: configuration
  block:
    - name: Check and set parameters
      ansible.builtin.include_tasks: elasticsearch-parameters.yml
      tags: configuration

    - name: Include Elasticsearch config
      ansible.builtin.include_tasks: elasticsearch-config.yml
      tags: configuration

  when: elastic_configure